class GroupVoiceChat{constructor(){this.peerId=this.generateReadableId(),this.roomId=null,this.localStream=null,this.peerConnections={},this.remoteStreams={},this.ws=null,this.isMuted=!1,this.isDeafened=!1,this.isConnecting=!1,this.messageInput=null,this.maxFileSize=10485760,this.init()}generateReadableId(){var e=["–ñ–∏–≤–æ–π","–í–µ—Å—ë–ª—ã–π","–õ—É–∫–∞–≤—ã–π","–°—Ç—Ä–∞–Ω–Ω—ã–π","–ü—É—à–∏—Å—Ç—ã–π","–°–ª–∞–¥–∫–∏–π","–ó–µ—Ä–∫–∞–ª—å–Ω—ã–π","–®–µ—Ä—à–∞–≤—ã–π","–ë–ª–µ—Å—Ç—è—â–∏–π","–¢—ë–ø–ª—ã–π","–°–∫—Ä–∏–ø—É—á–∏–π","–õ–µ–Ω–∏–≤—ã–π","–ú–µ—Ä—Ü–∞—é—â–∏–π","–ë–∞—Ä—Ö–∞—Ç–Ω—ã–π","–•—Ä—É—Å—Ç–∞–ª—å–Ω—ã–π","–û–≥–Ω–µ–Ω–Ω—ã–π","–õ–µ–¥—è–Ω–æ–π","–ú–æ—Ö–Ω–∞—Ç—ã–π","–°–æ—á–Ω—ã–π","–®—É—Ä—à–∞—â–∏–π","–õ—É–Ω–Ω—ã–π","–°–æ–ª–Ω–µ—á–Ω—ã–π","–ú—è–≥–∫–∏–π","–ò—Å–∫—Ä–∏—Å—Ç—ã–π","–ó–∞–¥—É–º—á–∏–≤—ã–π","–ü—Ä—ã–≥—É—á–∏–π","–í–æ–∑–¥—É—à–Ω—ã–π","–ì–æ–≤–æ—Ä–ª–∏–≤—ã–π"],t=["–º—è—Å–æ—Ä—É–±–∫–∞","—à–ª—è–ø–∞","—Ç–∞–ø–æ–∫","–∑–æ–Ω—Ç–∏–∫","–Ω–æ—Å–æ—Ä–æ–≥","–≤–µ–¥—ë—Ä–∫–æ","—Ç–æ—Ä—Ç","–ª–∞–º–ø–æ—á–∫–∞","–±–∞–Ω–∞–Ω","—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫","–∫–∞–∫—Ç—É—Å","–≥–∞—Ä–º–æ—à–∫–∞","–∫—Ä–æ–∫–æ–¥–∏–ª","–ø—É–≥–æ–≤–∏—Ü–∞","–ø–æ–¥—É—à–∫–∞","—Å–∞–º–æ–ª—ë—Ç","–º—ã—à–æ–Ω–æ–∫","–±—É–¥–∏–ª—å–Ω–∏–∫","—è—â–µ—Ä–∫–∞","—Ç–µ–ª–µ—Å–∫–æ–ø","–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å","–∫–æ–≤–µ—Ä","–∑—É–±–æ—á–∏—Å—Ç–∫–∞","–º–∏—Å–∫–∞","–æ–±–ª–∞–∫–æ","–±–∞—Ä–∞–Ω–∫–∞","–æ–¥–µ—è–ª–æ","–º–æ—Ä–∫–æ–≤–∫–∞","–≤–æ–ª—á–æ–∫","—Ñ–æ–Ω–∞—Ä—å"],t=t[Math.floor(Math.random()*t.length)],e=e[Math.floor(Math.random()*e.length)];let n=e;return t.endsWith("–∞")&&(n=e.slice(0,-2)+"–∞—è"),(n=t.endsWith("–æ")?e.slice(0,-2)+"–æ–µ":n)+" "+t}async init(){["joinRoom","leaveRoom","muteIcon","deafenIcon","messageInput","sendMessage","roomId","statusCompact","myId","currentRoom","participantCount","attachButton"].forEach(e=>{document.getElementById(e)?console.log("Element found:",e):console.error("Element not found:",e)});var e=document.getElementById("myId");if(e&&(e.textContent=this.peerId),this.setupEventListeners(),await this.setupTextChat(),"Notification"in window&&"default"===Notification.permission)try{await Notification.requestPermission()}catch(e){console.log("Notification permission denied")}}async setupTextChat(){this.messageInput=document.getElementById("messageInput"),document.getElementById("sendMessage").addEventListener("click",()=>{this.sendTextMessage()}),this.messageInput.addEventListener("keypress",e=>{"Enter"===e.key&&this.sendTextMessage()})}async sendTextMessage(){var e=this.messageInput.value.trim();e&&this.ws&&this.ws.readyState===WebSocket.OPEN&&(this.ws.send(JSON.stringify({type:"text_message",message:e,timestamp:(new Date).toISOString()})),this.messageInput.value="")}async addMessageToChat(e,t,n=!1){var o=document.createElement("div"),s=(o.className="message "+(n?"own-message":"other-message"),(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),a=document.createElement("div"),i=(a.className="message-header",document.createElement("div")),c=(i.className="message-avatar",i.textContent=n?"Y":e.charAt(0).toUpperCase(),document.createElement("span")),d=(c.className="message-sender",c.textContent=n?"–í—ã":""+e,document.createElement("span")),s=(d.className="message-time",d.textContent=s,n?(console.log("–î–ª—è —Å–≤–æ–∏—Ö"),a.appendChild(d),a.appendChild(c),a.appendChild(i)):(console.log("–î–ª—è —á—É–∂–∏—Ö"),a.appendChild(i),a.appendChild(c),a.appendChild(d)),document.createElement("div")),i=(s.className="message-content",s.textContent=t,o.appendChild(a),o.appendChild(s),document.getElementById("chatMessages"));i.appendChild(o),i.scrollTop=i.scrollHeight,!n&&document.hidden&&"Notification"in window&&"granted"===Notification.permission&&new Notification("–°–æ–æ–±—â–µ–Ω–∏–µ",{body:`–û—Ç: ${e} 
`+t,icon:"data:image/png;base64,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"})}async joinRoom(e=""){if(console.log("Join room called with roomId:",e),e||(e=(t=document.getElementById("roomId")).value.trim()||"100",t.value=e),this.isConnecting)console.log("Already connecting, skipping...");else{this.isConnecting=!0;var t=document.getElementById("joinRoom"),n=document.getElementById("statusCompact");t&&(t.disabled=!0),n&&(n.textContent="Connecting...");try{console.log("Step 1: Connecting WebSocket..."),await this.connectWebSocket(),console.log("Step 2: Waiting for WebSocket to be ready..."),await this.waitForWebSocketConnection(),console.log("Step 3: Sending join message..."),this.ws.send(JSON.stringify({type:"join",peer_id:this.peerId,room_id:e})),console.log("Join message sent successfully")}catch(e){console.error("Error in join process:",e),alert("Error joining room: "+e.message),t&&(t.disabled=!1),this.isConnecting=!1,n&&(n.textContent="Failed")}}}async connectWebSocket(){if(console.log("connectWebSocket called"),this.ws){if(console.log("Existing WebSocket found, state:",this.ws.readyState),this.ws.readyState===WebSocket.OPEN)return console.log("WebSocket already open, reusing"),Promise.resolve();if(this.ws.readyState===WebSocket.CONNECTING)return console.log("WebSocket already connecting, waiting..."),this.waitForWebSocketConnection();console.log("WebSocket in state",this.ws.readyState,", creating new connection"),this.ws.close()}return new Promise((t,o)=>{console.log("Creating new WebSocket connection to ws://localhost:8080/ws");try{var e=("https:"===window.location.protocol?"wss:":"ws:")+`//${window.location.host}/ws`;this.ws=new WebSocket(e),console.log("Connecting to:",e);let n=setTimeout(()=>{console.error("WebSocket connection timeout"),o(new Error("WebSocket connection timeout")),this.ws&&this.ws.readyState===WebSocket.CONNECTING&&this.ws.close()},1e4);this.ws.onopen=()=>{console.log("WebSocket connection opened successfully"),clearTimeout(n);var e=document.getElementById("statusCompact");e&&(e.textContent="Connected",e.classList.add("connected")),t()},this.ws.onerror=e=>{console.error("WebSocket connection error:",e),clearTimeout(n),o(new Error("WebSocket connection failed"))},this.ws.onclose=e=>{console.log("WebSocket connection closed:",e.code,e.reason),clearTimeout(n);var e=document.getElementById("status"),t=document.getElementById("statusCompact");e&&(e.textContent="Disconnected from server"),t&&(t.textContent="Disconnected",t.classList.remove("connected")),this.isConnecting&&o(new Error("WebSocket closed during connection"))},this.ws.onmessage=t=>{try{console.log("WebSocket message received:",t.data);var e=JSON.parse(t.data);this.handleSignalingData(e)}catch(e){console.error("Error parsing WebSocket message:",e,t.data)}}}catch(e){console.error("Error creating WebSocket:",e),o(new Error("Failed to create WebSocket"))}})}waitForWebSocketConnection(){return console.log("Waiting for WebSocket connection..."),new Promise((e,t)=>{let n=Date.now(),o=()=>{this.ws?(console.log("WebSocket state:",this.ws.readyState),this.ws.readyState===WebSocket.OPEN?(console.log("WebSocket connected successfully"),e()):this.ws.readyState===WebSocket.CLOSED||this.ws.readyState===WebSocket.CLOSING?(console.error("WebSocket failed to connect"),t(new Error("WebSocket failed to connect"))):15e3<Date.now()-n?(console.error("WebSocket connection timeout"),t(new Error("WebSocket connection timeout"))):setTimeout(o,100)):(console.error("WebSocket not initialized"),t(new Error("WebSocket not initialized")))};o()})}async handleSignalingData(e){switch(e.type){case"room_joined":this.handleRoomJoined(e);break;case"peer_joined":await this.handlePeerJoined(e.peer_id);break;case"peer_left":this.handlePeerLeft(e.peer_id);break;case"peer_list_update":this.handlePeerListUpdate(e.peers);break;case"offer":await this.handleOffer(e);break;case"answer":await this.handleAnswer(e);break;case"ice-candidate":await this.handleIceCandidate(e);break;case"text_message":var t=e.from_peer===this.peerId;console.log("Received message:",{from:e.from_peer,own:this.peerId,isOwn:t}),await this.addMessageToChat(e.from_peer,e.message,t);break;case"file_message":await this.handleFileMessage(e);break;case"error":alert(e.message),this.isConnecting=!1,document.getElementById("joinRoom").disabled=!1}}handlePeerListUpdate(e){console.log("Peer list updated:",e),this.updatePeerList(e)}handleRoomJoined(e){this.roomId=e.room_id,this.isConnecting=!1;var t=document.getElementById("leaveRoom"),n=document.getElementById("muteIcon"),o=document.getElementById("deafenIcon"),s=document.getElementById("messageInput"),a=document.getElementById("sendMessage"),i=document.getElementById("joinRoom"),c=document.getElementById("roomId"),d=document.getElementById("status"),r=document.getElementById("statusCompact"),l=document.getElementById("currentRoom"),m=document.getElementById("attachButton"),l=(l&&(l.textContent=this.roomId),t&&(t.disabled=!1),n&&(n.disabled=!1),o&&(o.disabled=!1),s&&(s.disabled=!1),a&&(a.disabled=!1),m&&(m.disabled=!1),i&&(i.disabled=!0),c&&(c.disabled=!0),d&&(d.textContent="Connected to room "+this.roomId),r&&(r.textContent="Connected",r.classList.add("connected")),[this.peerId,...e.peers]);this.updatePeerList(l),setTimeout(()=>{e.peers.forEach(e=>{this.connectToPeer(e)})},1e3),this.updateAudioElements(),console.log(`Joined room: ${this.roomId} with peers:`,e.peers)}async connectToPeer(e){if(!this.peerConnections[e])try{this.localStream||(this.localStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:44100},video:!1}).catch(e=>{throw console.error("Error accessing microphone:",e),new Error("Microphone access denied. Please allow microphone access.")}));let t=this.createPeerConnection(e);this.peerConnections[e]=t,this.localStream.getTracks().forEach(e=>{t.addTrack(e,this.localStream)});var n=await t.createOffer();await t.setLocalDescription(n),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"offer",offer:n,target_peer:e})),this.updateAudioElements()}catch(e){console.error("Error connecting to peer:",e),e.message.includes("Microphone access denied")&&(alert("Please allow microphone access to use voice chat"),this.leaveRoom())}}createPeerConnection(t){let e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"turn:94.183.234.220:3478",username:"morzh",credential:"penis_morzha",credentialType:"password"},{urls:"turn:94.183.234.220:3478?transport=tcp",username:"morzh",credential:"penis_morzha"},{urls:"turns:94.183.234.220:5349?transport=tcp",username:"morzh",credential:"penis_morzha"}]});return e.onicecandidate=e=>{e.candidate?(console.log(`‚ùÑÔ∏è [${t}] ICE candidate:`,{type:e.candidate.type,protocol:e.candidate.protocol,address:e.candidate.address,port:e.candidate.port,candidateType:e.candidate.candidateType}),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"ice-candidate",candidate:e.candidate,target_peer:t}))):console.log(`‚úÖ [${t}] ICE gathering complete`)},e.ontrack=e=>{this.remoteStreams[t]=e.streams[0],this.updateAudioElements()},e.onconnectionstatechange=()=>{console.log(`üîó [${t}] Connection state: `+e.connectionState),"connected"===e.connectionState&&(console.log(`‚úÖ [${t}] Connection established!`),this.logConnectionDetails(e,t))},e.oniceconnectionstatechange=()=>{console.log(`üåê [${t}] ICE state: `+e.iceConnectionState)},e.onicegatheringstatechange=()=>{console.log(`üì° [${t}] ICE gathering: `+e.iceGatheringState)},e.onsignalingstatechange=()=>{console.log(`üì∂ [${t}] Signaling: `+e.signalingState)},e}async logConnectionDetails(e,s){try{console.group("üìä Connection details for "+s),console.log("üîÑ Connection state:",e.connectionState),console.log("üåê ICE state:",e.iceConnectionState);let t=await e.getStats(),n=null,o=null;t.forEach(e=>{"candidate-pair"===e.type&&e.nominated&&"succeeded"===e.state&&(console.log("‚≠ê ACTIVE Candidate Pair:",{state:e.state,bytesSent:e.bytesSent,bytesReceived:e.bytesReceived,priority:e.priority}),n=t.get(e.localCandidateId),o=t.get(e.remoteCandidateId))}),n&&o?(console.log("üéØ SELECTED Local Candidate:",{type:n.candidateType,ip:n.ip,port:n.port,protocol:n.protocol}),console.log("üéØ SELECTED Remote Candidate:",{type:o.candidateType,ip:o.ip,port:o.port,protocol:o.protocol}),console.log("üîó Connection Type:",this.getConnectionType(n,o))):console.log("‚è≥ Active candidate pair not found yet"),console.groupEnd()}catch(e){console.error("Error getting connection details:",e)}}getConnectionType(e,t){return"relay"===e.candidateType||"relay"===t.candidateType?"TURN (Relay)":"srflx"===e.candidateType||"srflx"===t.candidateType?"STUN (NAT Traversal)":"P2P (Local Network)"}updateAudioElements(){let s=document.getElementById("audioOutputContainer");var e;s&&(s.innerHTML="",0<Object.keys(this.remoteStreams).length&&!this.isDeafened&&((e=document.createElement("div")).className="audio-stream-info",e.textContent=Object.keys(this.remoteStreams).length+" active stream(s)",s.appendChild(e)),Object.entries(this.remoteStreams).forEach(([e,t])=>{var n,o;this.isDeafened||((n=document.createElement("div")).style.margin="8px 0",(o=document.createElement("audio")).className="remote-audio",o.srcObject=t,o.autoplay=!0,o.controls=!0,o.title="Peer: "+e,o.dataset.peerId=e,(t=document.querySelector(`.volume-slider[data-peer-id="${e}"]`))&&(o.volume=t.value/100),(t=document.createElement("div")).className="audio-stream-info",t.textContent=""+e,n.appendChild(o),n.appendChild(t),s.appendChild(n))}),0!==Object.keys(this.remoteStreams).length&&!this.isDeafened||((e=document.createElement("div")).style.color="#72767d",e.style.fontSize="12px",e.style.textAlign="center",e.style.padding="10px",this.isDeafened?(e.textContent="Audio deafened",e.style.color="#ed4245"):e.textContent="No active audio streams",s.appendChild(e)))}async handlePeerJoined(e){setTimeout(()=>{this.connectToPeer(e)},500)}handlePeerLeft(e){this.peerConnections[e]&&(this.peerConnections[e].close(),delete this.peerConnections[e]),delete this.remoteStreams[e],this.updateAudioElements()}updatePeerList(e=null){let n=document.getElementById("peerList");var t;n&&(e=e||Object.keys(this.peerConnections),n.innerHTML="",this.roomId?((t=document.createElement("div")).className="participant",t.innerHTML=`
            <div class="participant-avatar">Y</div>
            <div class="participant-info">
                <div class="participant-name">–í—ã: ${this.peerId}</div>
                <div class="status-online">‚óè Online</div>
            </div>
            <div class="volume-control" style="display: none;">
                <input type="range" min="0" max="100" value="100" class="volume-slider">
            </div>
        `,n.appendChild(t),e.forEach(e=>{var t;e!==this.peerId&&((t=document.createElement("div")).className="participant",t.dataset.peerId=e,t.innerHTML=`
                    <div class="participant-avatar">${e.charAt(0).toUpperCase()}</div>
                    <div class="participant-info">
                        <div class="participant-name">${e}</div>
                        <div class="status-online">‚óè Online</div>
                    </div>
                    <div class="volume-control">
                        <input type="range" min="0" max="100" value="100" 
                               class="volume-slider" data-peer-id="${e}">
                    </div>
                `,n.appendChild(t))}),(t=document.getElementById("participantCount"))&&(t.textContent=String(e.length)),this.setupVolumeControls()):(n.innerHTML=`
            <div class="participant">
                <div class="participant-avatar">Y</div>
                <div class="participant-info">
                    <div class="participant-name">–í—ã</div>
                    <div class="status-offline">‚óè Offline</div>
                </div>
            </div>
        `,document.getElementById("participantCount").textContent="0"))}setupVolumeControls(){document.querySelectorAll(".volume-slider").forEach(e=>{let t=e.dataset.peerId;t&&e.addEventListener("input",e=>{this.setPeerVolume(t,e.target.value/100)})})}setPeerVolume(e,t){var n=document.querySelector(`audio[title*="${e}"]`);n&&(n.volume=t),this.remoteStreams[e]}async handleOffer(e){try{this.localStream||(this.localStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0},video:!1}));let t=this.createPeerConnection(e.from_peer);this.peerConnections[e.from_peer]=t,this.localStream.getTracks().forEach(e=>{t.addTrack(e,this.localStream)}),await t.setRemoteDescription(e.offer);var n=await t.createAnswer();await t.setLocalDescription(n),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"answer",answer:n,target_peer:e.from_peer}))}catch(e){console.error("Error handling offer:",e)}}async handleAnswer(e){var t=this.peerConnections[e.from_peer];t&&await t.setRemoteDescription(e.answer)}async handleIceCandidate(e){var t=this.peerConnections[e.from_peer];t&&await t.addIceCandidate(e.candidate)}leaveRoom(){console.log("Leaving room...");var e=document.getElementById("joinRoom"),t=document.getElementById("leaveRoom"),n=document.getElementById("muteIcon"),o=document.getElementById("deafenIcon"),s=document.getElementById("attachButton"),a=document.getElementById("messageInput"),i=document.getElementById("sendMessage"),c=document.getElementById("roomId"),d=document.getElementById("status"),r=document.getElementById("statusCompact"),l=document.getElementById("currentRoom"),m=document.getElementById("chatMessages"),g=document.getElementById("audioOutputContainer");e&&(e.disabled=!1),t&&(t.disabled=!0),n&&(n.disabled=!0),o&&(o.disabled=!0),a&&(a.disabled=!0),i&&(i.disabled=!0),c&&(c.disabled=!1),s&&(s.disabled=!0),c&&(c.value=""),d&&(d.textContent="Disconnected"),r&&(r.textContent="Disconnected",r.classList.remove("connected")),l&&(l.textContent="Not connected"),m&&(m.innerHTML=`
            <div class="message other-message">
                <div class="message-header">
                    <div class="message-avatar">S</div>
                    <span class="message-sender">System</span>
                    <span class="message-time">Just now</span>
                </div>
                <div class="message-content">
                    Disconnected from room. Join a room to start talking.
                </div>
            </div>
        `),g&&(g.innerHTML=`
            <div style="color: #72767d; font-size: 12px; text-align: center; padding: 10px;">
                No active audio streams
            </div>`),Object.values(this.peerConnections).forEach(e=>{e&&e.close()}),this.peerConnections={},this.remoteStreams={},this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"leave",room_id:this.roomId})),this.ws&&(this.ws.close(),this.ws=null),this.roomId=null,this.isConnecting=!1,this.updatePeerList([]),console.log("Left room successfully")}toggleMute(){var e;this.localStream&&((e=this.localStream.getAudioTracks()).forEach(e=>{e.enabled=!e.enabled}),this.isMuted=!e[0].enabled,e=document.getElementById("muteIcon"),this.isMuted?(e.classList.add("active"),e.innerHTML='<i class="icon-mic-off"></i>'):(e.classList.remove("active"),e.innerHTML='<i class="icon-mic-2"></i>'))}toggleDeafen(){this.isDeafened=!this.isDeafened;var e=document.getElementById("deafenIcon");this.isDeafened?e.classList.add("active"):e.classList.remove("active"),e.innerHTML='<i class="icon-headphones-1"></i>',this.updateAudioElements()}handleAttachClick(){console.log("Attach button clicked"),this.toggleAttachMenu()}toggleAttachMenu(){var e=document.getElementById("attachMenu");e&&(e.classList.toggle("open"),console.log("Attach menu toggled:",e.classList.contains("open")))}setupEventListeners(){console.log("Setting up event listeners...");var e=document.getElementById("joinRoom"),t=document.getElementById("leaveRoom"),n=document.getElementById("muteIcon"),o=document.getElementById("deafenIcon"),s=document.getElementById("messageInput"),a=document.getElementById("sendMessage"),i=document.getElementById("roomId"),c=document.getElementById("attachButton");c?(c.addEventListener("click",e=>{e.preventDefault(),this.handleAttachClick()}),console.log("Attach button listener added")):console.error("Attach button not found"),e?(e.addEventListener("click",()=>{var e=document.getElementById("roomId").value.trim();this.joinRoom(e)}),console.log("Join button listener added")):console.error("Join button not found"),t?(t.addEventListener("click",()=>{this.leaveRoom()}),console.log("Leave button listener added")):console.error("Leave button not found"),n?(n.addEventListener("click",()=>{this.toggleMute()}),console.log("Mute button listener added")):console.error("Mute button not found"),o?(o.addEventListener("click",()=>{this.toggleDeafen()}),console.log("Deafen button listener added")):console.error("Deafen button not found"),s&&s.addEventListener("keypress",e=>{"Enter"===e.key&&this.sendTextMessage()}),a&&a.addEventListener("click",()=>{this.sendTextMessage()}),i&&i.addEventListener("keypress",e=>{"Enter"===e.key&&(e=document.getElementById("joinRoom"))&&e.click()}),console.log("All event listeners setup completed")}async attachImage(){this.toggleAttachMenu();var e=document.createElement("input");e.type="file",e.accept="image/*",e.multiple=!1,e.onchange=async e=>{e=e.target.files[0];e&&(e.size>this.maxFileSize?alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 10MB"):await this.sendFile(e))},e.click()}async attachFile(){this.toggleAttachMenu();var e=document.createElement("input");e.type="file",e.multiple=!1,e.onchange=async e=>{e=e.target.files[0];e&&(e.size>this.maxFileSize?alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 10MB"):await this.sendFile(e))},e.click()}async sendFile(n){if(this.ws&&this.ws.readyState===WebSocket.OPEN)try{var e=new FileReader;e.onload=async e=>{var e=e.target.result,e=this.arrayBufferToBase64(e),t={name:n.name,type:n.type,size:n.size,data:e};await this.addFileMessage(this.peerId,t,!0),this.ws.send(JSON.stringify({type:"file_message",file_name:n.name,file_type:n.type,file_size:n.size,file_data:e,timestamp:(new Date).toISOString()}))},e.readAsArrayBuffer(n)}catch(e){console.error("Error sending file:",e),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞")}else alert("–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É")}arrayBufferToBase64(e){var t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return btoa(n)}async addFileMessage(e,t,n=!1){var o=document.createElement("div"),s=(o.className="message "+(n?"own-message":"other-message"),(new Date).toLocaleTimeString()),a=document.createElement("div"),n=(a.className="message-header",a.innerHTML=`
        <span class="message-sender">${n?"–í—ã":""+e}</span>
        <span class="message-time">${s}</span>
    `,document.createElement("div")),s=(n.className="message-file",t.type.startsWith("image/")?(e=`data:${t.type};base64,`+t.data,n.innerHTML=`
            <div class="file-content">
                <div class="file-icon"><i class="fas fa-image"></i></div>
                <div class="file-info">
                    <div class="file-name">${this.escapeHtml(t.name)}</div>
                    <div class="file-size">${this.formatFileSize(t.size)}</div>
                </div>
            </div>
            <img src="${e}" alt="${this.escapeHtml(t.name)}" class="file-image" 
                 onclick="app.openImage('${e}')">
        `):n.innerHTML=`
            <div class="file-content">
                <div class="file-icon"><i class="fas fa-file"></i></div>
                <div class="file-info">
                    <div class="file-name">${this.escapeHtml(t.name)}</div>
                    <div class="file-size">${this.formatFileSize(t.size)}</div>
                </div>
                <button class="file-download" onclick="app.downloadFile('${this.escapeHtml(t.name)}', '${t.type}', '${t.data}')">
                    –°–∫–∞—á–∞—Ç—å
                </button>
            </div>
        `,o.appendChild(a),o.appendChild(n),document.getElementById("chatMessages"));s.appendChild(o),s.scrollTop=s.scrollHeight}formatFileSize(e){var t;return 0===e?"0 Bytes":(t=Math.floor(Math.log(e)/Math.log(1024)),parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t])}escapeHtml(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}openImage(e){let t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        cursor: pointer;
    `;var n=document.createElement("img");n.src=e,n.style.cssText=`
        max-width: 90%;
        max-height: 90%;
        border-radius: 8px;
    `,t.appendChild(n),t.onclick=()=>document.body.removeChild(t),document.body.appendChild(t)}downloadFile(e,t,n){var o=atob(n),s=new Uint8Array(o.length);for(let e=0;e<o.length;e++)s[e]=o.charCodeAt(e);n=new Blob([s],{type:t}),t=URL.createObjectURL(n),n=document.createElement("a");n.href=t,n.download=e,n.click(),URL.revokeObjectURL(t)}async handleFileMessage(e){console.log("üìÅ File message received from:",e.from_peer),e.from_peer===this.peerId?console.log("Ignoring own file message (already shown locally)"):await this.addFileMessage(e.from_peer,{name:e.file_name,type:e.file_type,size:e.file_size,data:e.file_data},!1)}}document.addEventListener("DOMContentLoaded",()=>{window.app=new GroupVoiceChat});